<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0b09">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon-192.svg">
<title>TideTable ‚Äî Longboat Key</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap');

  :root {
    --ink: #e8e0d4;
    --ink-dim: #a89e90;
    --ink-faint: #6b6358;
    --paper: #0d0b09;
    --paper-light: #1a1714;
    --paper-lighter: #252119;
    --accent: #c4956a;
    --accent-dim: #8a6a4a;
    --rule: #2a2520;
    --serif: 'Playfair Display', 'Georgia', serif;
    --body: 'Source Serif 4', 'Georgia', serif;
    --mono: 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: var(--body);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  .page {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  /* Masthead */
  .masthead {
    text-align: center;
    padding: 2rem 0 1.5rem;
    border-bottom: 3px double var(--rule);
  }
  .masthead-rule { border-top: 1px solid var(--rule); margin-bottom: .5rem; }
  .masthead h1 {
    font-family: var(--serif);
    font-size: 3.2rem;
    font-weight: 700;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--ink);
    line-height: 1;
  }
  .masthead-sub {
    font-family: var(--body);
    font-style: italic;
    font-weight: 300;
    font-size: 1rem;
    color: var(--ink-dim);
    margin-top: .25rem;
  }
  .masthead-date {
    font-family: var(--mono);
    font-size: .75rem;
    color: var(--ink-faint);
    letter-spacing: .1em;
    text-transform: uppercase;
    margin-top: .75rem;
  }

  /* Section headers */
  .section-head {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 2rem 0 1rem;
  }
  .section-head::before, .section-head::after {
    content: '';
    flex: 1;
    border-top: 1px solid var(--rule);
  }
  .section-head h2 {
    font-family: var(--serif);
    font-size: 1.1rem;
    font-weight: 400;
    letter-spacing: .15em;
    text-transform: uppercase;
    color: var(--accent);
    white-space: nowrap;
  }

  /* Sun card */
  .sun-card {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1px;
    background: var(--rule);
    border: 1px solid var(--rule);
    margin-bottom: 1.5rem;
  }
  .sun-cell {
    background: var(--paper-light);
    padding: 1.25rem 1rem;
    text-align: center;
  }
  .sun-label {
    font-family: var(--mono);
    font-size: .65rem;
    letter-spacing: .15em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: .5rem;
  }
  .sun-value {
    font-family: var(--serif);
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--accent);
  }
  .sun-note {
    font-family: var(--body);
    font-style: italic;
    font-size: .8rem;
    color: var(--ink-dim);
    margin-top: .25rem;
  }

  /* Tide table */
  .tide-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--rule);
  }
  .tide-table thead th {
    font-family: var(--mono);
    font-size: .65rem;
    letter-spacing: .15em;
    text-transform: uppercase;
    color: var(--ink-faint);
    background: var(--paper-light);
    padding: .75rem 1rem;
    text-align: left;
    border-bottom: 2px solid var(--rule);
  }
  .tide-table tbody td {
    padding: .75rem 1rem;
    border-bottom: 1px solid var(--rule);
    font-family: var(--body);
    font-size: .95rem;
  }
  .tide-table tbody tr:last-child td { border-bottom: none; }
  .tide-table tbody tr:hover { background: var(--paper-light); }
  .tide-time {
    font-family: var(--mono);
    font-weight: 400;
    font-size: .9rem;
    color: var(--ink);
  }
  .tide-height {
    font-family: var(--mono);
    font-size: .9rem;
  }
  .tide-high { color: #6aacbe; }
  .tide-low { color: var(--accent); }
  .tide-type {
    font-family: var(--serif);
    font-style: italic;
    font-size: .85rem;
  }

  /* Tide chart */
  .tide-chart {
    margin: 1.5rem 0;
    border: 1px solid var(--rule);
    background: var(--paper-light);
    padding: 1.25rem;
  }
  .tide-chart canvas {
    width: 100%;
    height: 200px;
  }

  /* Forecast */
  .forecast-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1px;
    background: var(--rule);
    border: 1px solid var(--rule);
  }
  .forecast-day {
    background: var(--paper-light);
    padding: 1rem;
    text-align: center;
  }
  .forecast-day-name {
    font-family: var(--mono);
    font-size: .65rem;
    letter-spacing: .15em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: .5rem;
  }
  .forecast-icon { font-size: 1.4rem; margin-bottom: .25rem; }
  .forecast-tides {
    font-family: var(--body);
    font-size: .8rem;
    color: var(--ink-dim);
    font-style: italic;
    margin-top: .25rem;
  }
  .forecast-sun-time {
    font-family: var(--mono);
    font-size: .75rem;
    color: var(--accent-dim);
    margin-top: .25rem;
  }

  /* Moon */
  .moon-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    border: 1px solid var(--rule);
    background: var(--paper-light);
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
  }
  .moon-icon { font-size: 3rem; }
  .moon-info h3 {
    font-family: var(--serif);
    font-weight: 400;
    font-size: 1.1rem;
    color: var(--ink);
  }
  .moon-info p {
    font-family: var(--body);
    font-style: italic;
    font-size: .85rem;
    color: var(--ink-dim);
    margin-top: .15rem;
  }

  /* Conditions */
  .conditions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 1px;
    background: var(--rule);
    border: 1px solid var(--rule);
  }
  .cond-cell {
    background: var(--paper-light);
    padding: 1rem;
    text-align: center;
  }
  .cond-label {
    font-family: var(--mono);
    font-size: .6rem;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: .35rem;
  }
  .cond-value {
    font-family: var(--serif);
    font-size: 1.3rem;
    color: var(--ink);
  }
  .cond-unit {
    font-family: var(--body);
    font-size: .75rem;
    color: var(--ink-dim);
  }

  /* Solunar */
  .solunar-timeline {
    position: relative;
    border: 1px solid var(--rule);
    background: var(--paper-light);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .solunar-bar {
    position: relative;
    height: 48px;
    background: var(--paper);
    border: 1px solid var(--rule);
    border-radius: 4px;
    margin: 1rem 0 .75rem;
    overflow: hidden;
  }
  .solunar-period {
    position: absolute;
    top: 0;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--mono);
    font-size: .6rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--ink);
    border-radius: 3px;
  }
  .solunar-major {
    background: rgba(106, 172, 190, .25);
    border: 1px solid rgba(106, 172, 190, .4);
  }
  .solunar-minor {
    background: rgba(196, 149, 106, .18);
    border: 1px solid rgba(196, 149, 106, .3);
  }
  .solunar-labels {
    display: flex;
    justify-content: space-between;
    font-family: var(--mono);
    font-size: .6rem;
    color: var(--ink-faint);
    letter-spacing: .08em;
  }
  .solunar-legend {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    margin-top: .75rem;
  }
  .solunar-legend-item {
    display: flex;
    align-items: center;
    gap: .4rem;
    font-family: var(--mono);
    font-size: .6rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--ink-dim);
  }
  .solunar-legend-swatch {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }
  .solunar-rating {
    text-align: center;
    margin-top: 1rem;
    padding-top: .75rem;
    border-top: 1px solid var(--rule);
  }
  .solunar-rating-label {
    font-family: var(--mono);
    font-size: .6rem;
    letter-spacing: .15em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: .35rem;
  }
  .solunar-rating-stars {
    font-size: 1.2rem;
    letter-spacing: .15em;
  }
  .solunar-rating-text {
    font-family: var(--body);
    font-style: italic;
    font-size: .8rem;
    color: var(--ink-dim);
    margin-top: .2rem;
  }
  .solunar-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: var(--rule);
    border: 1px solid var(--rule);
    margin-top: 1rem;
  }
  .solunar-detail-cell {
    background: var(--paper-light);
    padding: .75rem 1rem;
    text-align: center;
  }
  .solunar-detail-label {
    font-family: var(--mono);
    font-size: .55rem;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: .3rem;
  }
  .solunar-detail-time {
    font-family: var(--serif);
    font-size: 1.1rem;
    color: var(--ink);
  }
  .solunar-detail-type {
    font-family: var(--body);
    font-style: italic;
    font-size: .7rem;
    margin-top: .15rem;
  }
  .solunar-detail-major { color: #6aacbe; }
  .solunar-detail-minor { color: var(--accent); }

  /* Footer */
  .footer {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 3px double var(--rule);
    text-align: center;
  }
  .footer p {
    font-family: var(--mono);
    font-size: .65rem;
    color: var(--ink-faint);
    letter-spacing: .1em;
  }

  /* Now marker */
  .now-marker {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 2s infinite;
    margin-right: .35rem;
    vertical-align: middle;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .3; }
  }

  .loading {
    text-align: center;
    padding: 3rem;
    font-family: var(--body);
    font-style: italic;
    color: var(--ink-dim);
  }

  @media (max-width: 600px) {
    .masthead h1 { font-size: 2.2rem; }
    .sun-card { grid-template-columns: 1fr; }
    .conditions-grid { grid-template-columns: 1fr 1fr; }
    .forecast-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
  }
</style>
</head>
<body>
<div class="page">
  <div class="masthead">
    <div class="masthead-rule"></div>
    <h1>TideTable</h1>
    <div class="masthead-sub">Longboat Key, Florida</div>
    <div class="masthead-date" id="dateDisplay"></div>
  </div>

  <div id="content"><div class="loading">Fetching tides & weather‚Ä¶</div></div>
</div>

<script>
const LAT = 27.4128, LON = -82.6715;
const NOAA_STATION = '8726347'; // Longboat Key Pass
const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function fmt(d) {
  return `${DAYS[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
}
function fmtTime(d) {
  let h = d.getHours(), m = d.getMinutes(), ap = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return `${h}:${String(m).padStart(2,'0')} ${ap}`;
}
function pad(n) { return String(n).padStart(2,'0'); }

document.getElementById('dateDisplay').textContent = fmt(new Date()).toUpperCase();

async function fetchJSON(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// Moon phase calculation (simplified)
function getMoonPhase(date) {
  const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate();
  let c = 0, e = 0;
  if (m < 3) { c = y - 1; e = m + 12; } else { c = y; e = m; }
  const jd = Math.floor(365.25 * (c + 4716)) + Math.floor(30.6001 * (e + 1)) + d - 1524.5;
  const daysNew = jd - 2451549.5;
  const cycles = daysNew / 29.53059;
  const phase = (cycles - Math.floor(cycles));
  const age = phase * 29.53;
  let name, icon;
  if (age < 1.85) { name = 'New Moon'; icon = 'üåë'; }
  else if (age < 5.53) { name = 'Waxing Crescent'; icon = 'üåí'; }
  else if (age < 9.22) { name = 'First Quarter'; icon = 'üåì'; }
  else if (age < 12.91) { name = 'Waxing Gibbous'; icon = 'üåî'; }
  else if (age < 16.61) { name = 'Full Moon'; icon = 'üåï'; }
  else if (age < 20.30) { name = 'Waning Gibbous'; icon = 'üåñ'; }
  else if (age < 23.99) { name = 'Last Quarter'; icon = 'üåó'; }
  else if (age < 27.68) { name = 'Waning Crescent'; icon = 'üåò'; }
  else { name = 'New Moon'; icon = 'üåë'; }
  return { name, icon, age: Math.round(age * 10) / 10, illumination: Math.round((1 - Math.cos(phase * 2 * Math.PI)) / 2 * 100) };
}

// Solunar forecast: moon transit ‚Üí major/minor feeding periods
function calcSolunar(date, lat) {
  // Approximate moon rise/set/transit using simplified algorithm
  const J2000 = 2451545.0;
  function toJD(d) {
    return d.getTime() / 86400000 + 2440587.5;
  }
  function fromJD(jd) {
    return new Date((jd - 2440587.5) * 86400000);
  }

  // Moon's approximate right ascension and declination
  function moonPos(jd) {
    const T = (jd - J2000) / 36525;
    const L = (218.3165 + 481267.8813 * T) % 360; // mean longitude
    const M = (134.9634 + 477198.8676 * T) % 360; // mean anomaly
    const F = (93.2721 + 483202.0175 * T) % 360;  // argument of latitude
    const D = (297.8502 + 445267.1115 * T) % 360;  // mean elongation
    const Ms = (357.5291 + 35999.0503 * T) % 360;  // sun mean anomaly
    const toR = Math.PI / 180;

    let lon = L
      + 6.289 * Math.sin(M * toR)
      + 1.274 * Math.sin((2*D - M) * toR)
      + 0.658 * Math.sin(2*D * toR)
      + 0.214 * Math.sin(2*M * toR)
      - 0.186 * Math.sin(Ms * toR)
      - 0.114 * Math.sin(2*F * toR);
    lon = ((lon % 360) + 360) % 360;

    let lat2 = 5.128 * Math.sin(F * toR)
      + 0.281 * Math.sin((M + F) * toR)
      + 0.278 * Math.sin((2*D - F) * toR);

    const obliq = 23.4393 - 0.013 * T;
    const lonR = lon * toR, latR = lat2 * toR, oblR = obliq * toR;
    const ra = Math.atan2(
      Math.sin(lonR) * Math.cos(oblR) - Math.tan(latR) * Math.sin(oblR),
      Math.cos(lonR)
    ) * 180 / Math.PI;
    const dec = Math.asin(
      Math.sin(latR) * Math.cos(oblR) + Math.cos(latR) * Math.sin(oblR) * Math.sin(lonR)
    ) * 180 / Math.PI;
    return { ra: ((ra % 360) + 360) % 360, dec };
  }

  // Sidereal time at Greenwich
  function gmst(jd) {
    const T = (jd - J2000) / 36525;
    let st = 280.46061837 + 360.98564736629 * (jd - J2000) + 0.000387933 * T * T;
    return ((st % 360) + 360) % 360;
  }

  // Find moon transit (upper culmination) nearest to noon
  const jd0 = Math.floor(toJD(date) - 0.5) + 0.5; // midnight JD
  let transitJD = null;
  // Search in 0.01-day increments
  let bestHA = 999;
  for (let f = 0; f < 1.2; f += 0.005) {
    const jd = jd0 + f;
    const mp = moonPos(jd);
    const st = gmst(jd) + (-82.6715); // local sidereal time (longitude)
    let ha = ((st - mp.ra) % 360 + 360) % 360;
    if (ha > 180) ha -= 360;
    if (Math.abs(ha) < bestHA) {
      bestHA = Math.abs(ha);
      transitJD = jd;
    }
  }

  // Moon underfoot (opposite transit) ~12.4h offset
  const HALF_LUNAR_DAY = 0.5 + 0.01; // ~12.4h in days ‚âà 0.517
  const underfootJD = transitJD < jd0 + 0.5 ? transitJD + HALF_LUNAR_DAY : transitJD - HALF_LUNAR_DAY;

  // Moon rise/set: approximate by finding when altitude crosses 0
  const latR = lat * Math.PI / 180;
  function moonAlt(jd) {
    const mp = moonPos(jd);
    const st = gmst(jd) + (-82.6715);
    const ha = (st - mp.ra) * Math.PI / 180;
    const decR = mp.dec * Math.PI / 180;
    return Math.asin(Math.sin(latR) * Math.sin(decR) + Math.cos(latR) * Math.cos(decR) * Math.cos(ha)) * 180 / Math.PI;
  }

  let moonRiseJD = null, moonSetJD = null;
  for (let f = 0; f < 1.2; f += 0.003) {
    const jd1 = jd0 + f, jd2 = jd0 + f + 0.003;
    const a1 = moonAlt(jd1), a2 = moonAlt(jd2);
    if (a1 < 0 && a2 >= 0 && !moonRiseJD) {
      moonRiseJD = jd1 + 0.003 * (-a1) / (a2 - a1);
    }
    if (a1 >= 0 && a2 < 0 && !moonSetJD) {
      moonSetJD = jd1 + 0.003 * (a1) / (a1 - a2);
    }
  }

  // Major periods: 2h centered on transit and underfoot
  // Minor periods: 1h centered on moonrise and moonset
  const MAJOR_HALF = 1 / 24; // 1h each side
  const MINOR_HALF = 0.5 / 24; // 30min each side

  const periods = [];
  if (transitJD) {
    periods.push({ type: 'major', label: 'Moon Overhead', center: fromJD(transitJD), start: fromJD(transitJD - MAJOR_HALF), end: fromJD(transitJD + MAJOR_HALF) });
  }
  if (underfootJD) {
    periods.push({ type: 'major', label: 'Moon Underfoot', center: fromJD(underfootJD), start: fromJD(underfootJD - MAJOR_HALF), end: fromJD(underfootJD + MAJOR_HALF) });
  }
  if (moonRiseJD) {
    periods.push({ type: 'minor', label: 'Moonrise', center: fromJD(moonRiseJD), start: fromJD(moonRiseJD - MINOR_HALF), end: fromJD(moonRiseJD + MINOR_HALF) });
  }
  if (moonSetJD) {
    periods.push({ type: 'minor', label: 'Moonset', center: fromJD(moonSetJD), start: fromJD(moonSetJD - MINOR_HALF), end: fromJD(moonSetJD + MINOR_HALF) });
  }

  // Sort by start time
  periods.sort((a, b) => a.start - b.start);

  // Rating based on moon phase (full/new = best)
  const moon = getMoonPhase(date);
  let rating, ratingText;
  if (moon.name === 'New Moon' || moon.name === 'Full Moon') {
    rating = 5; ratingText = 'Excellent ‚Äî peak solunar activity';
  } else if (moon.name === 'First Quarter' || moon.name === 'Last Quarter') {
    rating = 3; ratingText = 'Average ‚Äî moderate feeding activity';
  } else if (moon.age < 3 || moon.age > 27 || (moon.age > 13 && moon.age < 17)) {
    rating = 4; ratingText = 'Good ‚Äî strong feeding expected';
  } else {
    rating = 2; ratingText = 'Fair ‚Äî light feeding periods';
  }

  return { periods, rating, ratingText };
}

async function init() {
  const now = new Date();
  const today = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}`;
  const end = new Date(now); end.setDate(end.getDate() + 6);
  const endStr = `${end.getFullYear()}${pad(end.getMonth()+1)}${pad(end.getDate())}`;

  try {
    const [tideData, weatherData, waterTempData] = await Promise.all([
      fetchJSON(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${today}&end_date=${endStr}&station=${NOAA_STATION}&product=predictions&datum=MLLW&time_zone=lst_ldt&units=english&interval=hilo&format=json`),
      fetchJSON(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=sunrise,sunset,temperature_2m_max,temperature_2m_min,weathercode&current=temperature_2m,relative_humidity_2m,wind_speed_10m,apparent_temperature&hourly=temperature_2m&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America/New_York&forecast_days=7`),
      fetchJSON(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?date=latest&station=${NOAA_STATION}&product=water_temperature&units=english&time_zone=lst_ldt&format=json`).catch(() => null)
    ]);

    // Water temperature
    const waterTemp = waterTempData?.data?.[0]?.v ? parseFloat(waterTempData.data[0].v) : null;

    // Marine conditions via Open-Meteo marine API
    let marineData = null;
    try {
      marineData = await fetchJSON('https://marine-api.open-meteo.com/v1/marine?latitude=27.41&longitude=-82.67&current=wave_height,wave_period&daily=wave_height_max&timezone=America/New_York&forecast_days=1').catch(() => null);
    } catch(e) { /* marine data unavailable */ }

    // Red tide status ‚Äî HABSOS API is not reliably accessible client-side (CORS),
    // so we show marine wave conditions as a proxy for ocean health and note
    // that users should check FWC's official HAB status page for red tide info.
    let redTideStatus = null;
    try {
      // Use wave height as a rough marine conditions indicator
      const waveHeight = marineData?.current?.wave_height;
      if (waveHeight != null) {
        if (waveHeight > 2.0) redTideStatus = { level: 'Rough', color: '#e74c3c', desc: `Waves ${waveHeight}m ‚Äî check FWC for HAB status` };
        else if (waveHeight > 1.0) redTideStatus = { level: 'Moderate', color: '#f39c12', desc: `Waves ${waveHeight}m ‚Äî check FWC for HAB status` };
        else redTideStatus = { level: 'Calm', color: '#27ae60', desc: `Waves ${waveHeight}m ‚Äî check FWC for HAB status` };
      }
    } catch(e) { /* red tide data unavailable */ }

    const preds = tideData.predictions || [];
    const todayPreds = preds.filter(p => p.t.startsWith(today.substring(0,4) + '-' + today.substring(4,6) + '-' + today.substring(6,8)));
    const moon = getMoonPhase(now);

    // Sun times
    const sunrise = new Date(weatherData.daily.sunrise[0]);
    const sunset = new Date(weatherData.daily.sunset[0]);
    const dayLen = sunset - sunrise;
    const dayH = Math.floor(dayLen / 3600000);
    const dayM = Math.floor((dayLen % 3600000) / 60000);

    const cur = weatherData.current;

    // Weather codes to icons
    function wxIcon(code) {
      if (code <= 1) return '‚òÄÔ∏è';
      if (code <= 3) return '‚õÖ';
      if (code <= 48) return '‚òÅÔ∏è';
      if (code <= 67) return 'üåßÔ∏è';
      if (code <= 77) return 'üå®Ô∏è';
      if (code <= 82) return 'üå¶Ô∏è';
      if (code <= 99) return '‚õàÔ∏è';
      return 'üå§Ô∏è';
    }

    let html = '';

    // Sun section
    html += `
    <div class="section-head"><h2>‚òÄ Sun</h2></div>
    <div class="sun-card">
      <div class="sun-cell">
        <div class="sun-label">Sunrise</div>
        <div class="sun-value">${fmtTime(sunrise)}</div>
      </div>
      <div class="sun-cell">
        <div class="sun-label">Sunset</div>
        <div class="sun-value">${fmtTime(sunset)}</div>
      </div>
      <div class="sun-cell">
        <div class="sun-label">Day Length</div>
        <div class="sun-value">${dayH}h ${dayM}m</div>
      </div>
    </div>`;

    // Moon
    html += `
    <div class="moon-card">
      <div class="moon-icon">${moon.icon}</div>
      <div class="moon-info">
        <h3>${moon.name}</h3>
        <p>${moon.illumination}% illumination ¬∑ Day ${moon.age} of cycle</p>
      </div>
    </div>`;

    // Solunar forecast
    const solunar = calcSolunar(now, LAT);
    html += `<div class="section-head"><h2>üêü Solunar Forecast</h2></div>`;
    html += `<div class="solunar-timeline">`;

    // Timeline bar: 24h from midnight to midnight
    const dayStart = new Date(now); dayStart.setHours(0,0,0,0);
    const dayEnd = new Date(now); dayEnd.setHours(23,59,59,999);
    const dayMs = dayEnd - dayStart;

    html += `<div class="solunar-bar">`;
    for (const p of solunar.periods) {
      const startPct = Math.max(0, (p.start - dayStart) / dayMs * 100);
      const endPct = Math.min(100, (p.end - dayStart) / dayMs * 100);
      const widthPct = endPct - startPct;
      if (widthPct > 0) {
        html += `<div class="solunar-period solunar-${p.type}" style="left:${startPct}%;width:${widthPct}%;" title="${p.label}: ${fmtTime(p.start)} ‚Äì ${fmtTime(p.end)}">${p.type === 'major' ? 'MAJOR' : 'MINOR'}</div>`;
      }
    }
    html += `</div>`;
    html += `<div class="solunar-labels"><span>12 AM</span><span>6 AM</span><span>12 PM</span><span>6 PM</span><span>12 AM</span></div>`;

    html += `<div class="solunar-legend">
      <div class="solunar-legend-item"><div class="solunar-legend-swatch" style="background:rgba(106,172,190,.25);border:1px solid rgba(106,172,190,.4);"></div> Major (2hr)</div>
      <div class="solunar-legend-item"><div class="solunar-legend-swatch" style="background:rgba(196,149,106,.18);border:1px solid rgba(196,149,106,.3);"></div> Minor (1hr)</div>
    </div>`;

    // Detail grid
    html += `<div class="solunar-detail-grid">`;
    for (const p of solunar.periods) {
      const cls = p.type === 'major' ? 'solunar-detail-major' : 'solunar-detail-minor';
      html += `<div class="solunar-detail-cell">
        <div class="solunar-detail-label">${p.label}</div>
        <div class="solunar-detail-time">${fmtTime(p.start)} ‚Äì ${fmtTime(p.end)}</div>
        <div class="solunar-detail-type ${cls}">${p.type === 'major' ? '‚óè Major Period' : '‚óã Minor Period'}</div>
      </div>`;
    }
    html += `</div>`;

    // Rating
    const stars = '‚òÖ'.repeat(solunar.rating) + '‚òÜ'.repeat(5 - solunar.rating);
    html += `<div class="solunar-rating">
      <div class="solunar-rating-label">Today's Fishing Rating</div>
      <div class="solunar-rating-stars" style="color:var(--accent);">${stars}</div>
      <div class="solunar-rating-text">${solunar.ratingText}</div>
    </div>`;

    html += `</div>`;

    // Conditions
    html += `
    <div class="section-head"><h2>Current Conditions</h2></div>
    <div class="conditions-grid">
      <div class="cond-cell">
        <div class="cond-label">Temperature</div>
        <div class="cond-value">${Math.round(cur.temperature_2m)}¬∞</div>
        <div class="cond-unit">¬∞F</div>
      </div>
      <div class="cond-cell">
        <div class="cond-label">Feels Like</div>
        <div class="cond-value">${Math.round(cur.apparent_temperature)}¬∞</div>
        <div class="cond-unit">¬∞F</div>
      </div>
      <div class="cond-cell">
        <div class="cond-label">Humidity</div>
        <div class="cond-value">${cur.relative_humidity_2m}%</div>
        <div class="cond-unit">rel.</div>
      </div>
      <div class="cond-cell">
        <div class="cond-label">Wind</div>
        <div class="cond-value">${Math.round(cur.wind_speed_10m)}</div>
        <div class="cond-unit">mph</div>
      </div>
      ${waterTemp !== null ? `<div class="cond-cell">
        <div class="cond-label">Water Temp</div>
        <div class="cond-value" style="color:${waterTemp >= 75 ? '#27ae60' : waterTemp >= 65 ? '#f39c12' : '#3498db'}">${Math.round(waterTemp)}¬∞</div>
        <div class="cond-unit">¬∞F ¬∑ Gulf</div>
      </div>` : ''}
      ${redTideStatus ? `<div class="cond-cell">
        <div class="cond-label">Red Tide</div>
        <div class="cond-value" style="color:${redTideStatus.color};font-size:1.1rem;">${redTideStatus.level}</div>
        <div class="cond-unit">${redTideStatus.desc}</div>
      </div>` : `<div class="cond-cell">
        <div class="cond-label">Red Tide</div>
        <div class="cond-value" style="color:var(--ink-dim);">‚Äî</div>
        <div class="cond-unit">Data unavailable</div>
      </div>`}
    </div>`;

    // Today's tides
    html += `<div class="section-head"><h2>Today's Tides</h2></div>`;
    if (todayPreds.length) {
      html += `<table class="tide-table"><thead><tr><th>Time</th><th>Type</th><th>Height</th></tr></thead><tbody>`;
      for (const p of todayPreds) {
        const t = new Date(p.t.replace(' ', 'T'));
        const isHigh = p.type === 'H';
        html += `<tr>
          <td class="tide-time">${fmtTime(t)}</td>
          <td class="tide-type ${isHigh ? 'tide-high' : 'tide-low'}">${isHigh ? 'High Tide' : 'Low Tide'}</td>
          <td class="tide-height ${isHigh ? 'tide-high' : 'tide-low'}">${parseFloat(p.v).toFixed(2)} ft</td>
        </tr>`;
      }
      html += `</tbody></table>`;
    } else {
      html += `<p style="color:var(--ink-dim);font-style:italic;">No tide data available for today.</p>`;
    }

    // Tide chart (canvas)
    html += `
    <div class="tide-chart">
      <canvas id="tideCanvas" height="200"></canvas>
    </div>`;

    // 7-day forecast
    html += `<div class="section-head"><h2>7-Day Outlook</h2></div>
    <div class="forecast-grid">`;
    for (let i = 0; i < 7; i++) {
      const d = new Date(now); d.setDate(d.getDate() + i);
      const dayName = i === 0 ? 'Today' : DAYS[d.getDay()].substring(0,3);
      const hi = Math.round(weatherData.daily.temperature_2m_max[i]);
      const lo = Math.round(weatherData.daily.temperature_2m_min[i]);
      const sr = new Date(weatherData.daily.sunrise[i]);
      const ss = new Date(weatherData.daily.sunset[i]);
      html += `
      <div class="forecast-day">
        <div class="forecast-day-name">${dayName}</div>
        <div class="forecast-icon">${wxIcon(weatherData.daily.weathercode[i])}</div>
        <div style="font-family:var(--serif);font-size:1.1rem;">${hi}¬∞ <span style="color:var(--ink-faint);font-size:.85rem;">${lo}¬∞</span></div>
        <div class="forecast-sun-time">‚òÄ ${fmtTime(sr)} ‚Üí ${fmtTime(ss)}</div>
      </div>`;
    }
    html += `</div>`;

    // Footer
    html += `
    <div class="footer">
      <p>NOAA Station ${NOAA_STATION} ¬∑ Longboat Key Pass, FL ¬∑ Open-Meteo Weather</p>
      <p style="margin-top:.35rem;">Data refreshed on page load ¬∑ No cookies ¬∑ No tracking</p>
    </div>`;

    document.getElementById('content').innerHTML = html;

    // Draw tide chart
    setTimeout(() => drawTideChart(preds, now), 100);

  } catch (e) {
    document.getElementById('content').innerHTML = `
      <div class="loading">Unable to load data. Please refresh.<br><small style="color:var(--ink-faint);">${e.message}</small></div>`;
  }
}

function drawTideChart(preds, now) {
  const canvas = document.getElementById('tideCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 200 * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = 200;

  // Filter to today + tomorrow
  const todayStr = now.toISOString().substring(0,10);
  const tom = new Date(now); tom.setDate(tom.getDate() + 1);
  const tomStr = tom.toISOString().substring(0,10);
  const filtered = preds.filter(p => {
    const d = p.t.substring(0, 10);
    return d === todayStr || d === tomStr;
  });
  if (filtered.length < 2) return;

  const times = filtered.map(p => new Date(p.t.replace(' ','T')));
  const vals = filtered.map(p => parseFloat(p.v));
  const minV = Math.min(...vals) - 0.3;
  const maxV = Math.max(...vals) + 0.3;
  const minT = times[0].getTime();
  const maxT = times[times.length - 1].getTime();

  function x(t) { return ((t - minT) / (maxT - minT)) * (W - 60) + 30; }
  function y(v) { return H - 30 - ((v - minV) / (maxV - minV)) * (H - 50); }

  // Grid
  ctx.strokeStyle = '#2a2520';
  ctx.lineWidth = 0.5;
  for (let v = Math.ceil(minV); v <= Math.floor(maxV * 10) / 10; v += 0.5) {
    ctx.beginPath();
    ctx.moveTo(30, y(v));
    ctx.lineTo(W - 30, y(v));
    ctx.stroke();
    ctx.fillStyle = '#6b6358';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText(v.toFixed(1) + ' ft', 28, y(v) + 3);
  }

  // Interpolate curve using cubic spline approximation
  ctx.beginPath();
  ctx.strokeStyle = '#6aacbe';
  ctx.lineWidth = 2;
  const points = filtered.map((p, i) => ({ x: x(times[i].getTime()), y: y(vals[i]) }));
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) {
    const cp1x = (points[i-1].x + points[i].x) / 2;
    ctx.bezierCurveTo(cp1x, points[i-1].y, cp1x, points[i].y, points[i].x, points[i].y);
  }
  ctx.stroke();

  // Dots + labels
  filtered.forEach((p, i) => {
    const isHigh = p.type === 'H';
    ctx.beginPath();
    ctx.arc(points[i].x, points[i].y, 4, 0, Math.PI * 2);
    ctx.fillStyle = isHigh ? '#6aacbe' : '#c4956a';
    ctx.fill();
    ctx.fillStyle = '#a89e90';
    ctx.font = '9px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText(fmtTime(times[i]), points[i].x, points[i].y + (isHigh ? -10 : 16));
  });

  // Now marker
  const nowX = x(now.getTime());
  if (nowX >= 30 && nowX <= W - 30) {
    ctx.strokeStyle = '#c4956a';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(nowX, 10);
    ctx.lineTo(nowX, H - 20);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#c4956a';
    ctx.font = '9px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText('NOW', nowX, H - 8);
  }
}

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// Offline banner
window.addEventListener('online', () => {
  const b = document.getElementById('offlineBanner');
  if (b) b.remove();
  init(); // refresh data
});
window.addEventListener('offline', () => {
  if (!document.getElementById('offlineBanner')) {
    const b = document.createElement('div');
    b.id = 'offlineBanner';
    b.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#c4956a;color:#0d0b09;text-align:center;padding:.5rem;font-family:var(--mono);font-size:.75rem;letter-spacing:.1em;z-index:999;';
    b.textContent = 'OFFLINE ‚Äî SHOWING CACHED DATA';
    document.body.prepend(b);
  }
});

init();
</script>
</body>
</html>
